{% extends "core/base.html" %}
{% block title %}Usuarios - Admin{% endblock %}

{% block dashboard_content %}
<div class="bg-white shadow mt-3 -mx-3 sm:mx-0 rounded-none sm:rounded-2xl px-3 py-4 sm:p-6">

  <!-- Header -->
  <div class="flex flex-col sm:flex-row sm:items-center mb-4 gap-3">
    <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
      üë§ Lista de Usuarios
    </h1>

    <div class="flex flex-wrap gap-3">
  <a href="{% url 'usuarios:user_create' %}"
     class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-4 rounded-xl text-sm shadow">
    ‚ûï Agregar Usuario
  </a>

  <a href="{% url 'usuarios:role_list' %}"
     class="bg-slate-800 hover:bg-slate-900 text-white font-semibold py-2 px-4 rounded-xl text-sm shadow">
    üß© Roles
  </a>
</div>
  </div>

  <!-- Filtros -->
  <form id="form-filtros" method="get" class="mb-3 text-sm">
    <div class="flex flex-wrap items-end gap-3 bg-gray-50 border border-gray-200 rounded-xl px-4 py-3">

      <div class="w-full sm:flex-1 sm:min-w-[140px]">
        <label class="text-xs text-gray-600">Identidad / RUT</label>
        <input type="text" name="identidad" value="{{ filtros.identidad }}"
               placeholder="Filtrar"
               class="border rounded-lg px-3 py-2 w-full"
               autocomplete="off">
      </div>

      <div class="w-full sm:flex-1 sm:min-w-[180px]">
        <label class="text-xs text-gray-600">Nombre / Usuario</label>
        <input type="text" name="nombre" value="{{ filtros.nombre }}"
               placeholder="Nombre, usuario o email"
               class="border rounded-lg px-3 py-2 w-full"
               autocomplete="off">
      </div>

      <div class="w-full sm:flex-1 sm:min-w-[200px]">
        <label class="text-xs text-gray-600">Correo</label>
        <input type="text" name="email" value="{{ filtros.email }}"
               placeholder="Correo electr√≥nico"
               class="border rounded-lg px-3 py-2 w-full"
               autocomplete="off">
      </div>

      <div class="w-full sm:w-48 sm:flex-none">
        <label class="text-xs text-gray-600">Rol</label>
        <select name="rol" class="border rounded-lg px-3 py-2 w-full">
          <option value="">Todos</option>
          {% for r in roles %}
            <option value="{{ r.name }}" {% if filtros.rol == r.name %}selected{% endif %}>{{ r.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="w-full sm:w-40 sm:flex-none">
        <label class="text-xs text-gray-600">Activo</label>
        <select name="activo" class="border rounded-lg px-3 py-2 w-full">
          <option value="">Todos</option>
          <option value="1" {% if filtros.activo == '1' %}selected{% endif %}>S√≠</option>
          <option value="0" {% if filtros.activo == '0' %}selected{% endif %}>No</option>
        </select>
      </div>

      <div class="w-full sm:w-auto sm:flex-none flex items-center gap-2">
        <a href="{% url 'usuarios:user_list' %}"
           class="px-4 py-2 rounded-lg bg-red-100 hover:bg-red-200 text-red-600 text-sm font-medium whitespace-nowrap shadow">
          ‚ùå Limpiar
        </a>
      </div>

      <input type="hidden" name="cantidad" value="{{ cantidad }}">
    </div>
  </form>

  <!-- Tabla -->
  <div class="overflow-x-auto">
    <table class="table-auto w-full text-sm min-w-full sm:min-w-[1200px]" style="white-space: nowrap;">
      <thead class="bg-gray-100 text-gray-800 font-semibold text-left">
        <tr>
          <th class="px-4 py-2">Email</th>
          <th class="px-4 py-2">RUT</th>
          <th class="px-4 py-2">Nombre</th>
          <th class="px-4 py-2">Apellido</th>
          <th class="px-4 py-2">Nombre completo</th>
          <th class="px-4 py-2">Staff</th>
          <th class="px-4 py-2">2FA</th>
          <th class="px-4 py-2">Roles</th>
          <th class="px-4 py-2">Activo</th>
          <th class="px-4 py-2">Acciones</th>
        </tr>
      </thead>

      <tbody class="text-left divide-y divide-gray-100">
        {% for u in pagina %}
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-2">{{ u.email }}</td>
          <td class="px-4 py-2">{{ u.rut|default:"-" }}</td>
          <td class="px-4 py-2">{{ u.first_name|default:"-" }}</td>
          <td class="px-4 py-2">{{ u.last_name|default:"-" }}</td>
          <td class="px-4 py-2">{{ u.get_full_name|default:u.username }}</td>

          <td class="px-4 py-2">
            {% if u.is_staff %}
              <span class="inline-flex items-center px-3 py-1 rounded-full bg-sky-100 text-sky-800 text-xs font-semibold">S√≠</span>
            {% else %}
              <span class="inline-flex items-center px-3 py-1 rounded-full bg-gray-200 text-gray-700 text-xs font-semibold">No</span>
            {% endif %}
          </td>

          <td class="px-4 py-2">
            {% if u.two_factor_enabled %}
              <span class="inline-flex items-center px-3 py-1 rounded-full bg-emerald-100 text-emerald-800 text-xs font-semibold">Activo</span>
            {% else %}
              <span class="inline-flex items-center px-3 py-1 rounded-full bg-amber-100 text-amber-800 text-xs font-semibold">Pendiente</span>
            {% endif %}
          </td>

          <td class="px-4 py-2">
            {% for r in u.roles.all %}
              <span class="inline-flex items-center px-2 py-1 rounded-full bg-indigo-100 text-indigo-700 text-xs font-semibold mr-1">
                {{ r.name }}
              </span>
            {% empty %}
              <span class="text-gray-400 text-xs">Sin roles</span>
            {% endfor %}
          </td>

          <td class="px-4 py-2">
            {% if u.is_active %}
              <span class="inline-flex items-center px-3 py-1 rounded-full bg-emerald-100 text-emerald-800 text-xs font-semibold">‚úî S√≠</span>
            {% else %}
              <span class="inline-flex items-center px-3 py-1 rounded-full bg-red-100 text-red-700 text-xs font-semibold">‚úñ No</span>
            {% endif %}
          </td>

          <td class="px-4 py-2 space-x-2">
            <a href="{% url 'usuarios:user_edit' u.id %}" class="text-blue-600 hover:underline text-sm font-medium">
              ‚úèÔ∏è Editar
            </a>

            {% if request.user.is_superuser or request.user.is_staff %}
            <button type="button" onclick="openModal('{{ u.id }}', '{{ u.email }}')"
                    class="text-red-600 hover:underline text-sm font-medium">
              üóëÔ∏è Eliminar
            </button>
            {% endif %}

            {% if u.two_factor_enabled %}
            <button type="button" onclick="openReset2FAModal('{{ u.id }}', '{{ u.email }}')"
                    class="inline-block bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-yellow-200 transition">
              üîÑ Reset 2FA
            </button>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="10" class="p-4 text-center text-gray-500">No hay usuarios registrados.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Selector de cantidad -->
  <form method="get" class="mt-4 flex flex-wrap items-center gap-2 text-sm">
    <label for="cantidad" class="font-medium text-gray-700">Mostrar:</label>
    <select name="cantidad" id="cantidad" onchange="this.form.submit()" class="border rounded-lg px-3 py-1">
      <option value="10"  {% if cantidad == '10' %}selected{% endif %}>10</option>
      <option value="20"  {% if cantidad == '20' %}selected{% endif %}>20</option>
      <option value="50"  {% if cantidad == '50' %}selected{% endif %}>50</option>
      <option value="100" {% if cantidad == '100' %}selected{% endif %}>100</option>
    </select>

    <input type="hidden" name="identidad" value="{{ filtros.identidad }}">
    <input type="hidden" name="nombre" value="{{ filtros.nombre }}">
    <input type="hidden" name="email" value="{{ filtros.email }}">
    <input type="hidden" name="rol" value="{{ filtros.rol }}">
    <input type="hidden" name="activo" value="{{ filtros.activo }}">
  </form>

  <!-- Paginaci√≥n -->
  <div class="mt-3 flex justify-center gap-2 text-sm">
    {% if pagina.has_previous %}
      <a href="?page=1&cantidad={{ cantidad }}&identidad={{ filtros.identidad }}&nombre={{ filtros.nombre }}&email={{ filtros.email }}&rol={{ filtros.rol }}&activo={{ filtros.activo }}"
         class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">¬´ Primero</a>
      <a href="?page={{ pagina.previous_page_number }}&cantidad={{ cantidad }}&identidad={{ filtros.identidad }}&nombre={{ filtros.nombre }}&email={{ filtros.email }}&rol={{ filtros.rol }}&activo={{ filtros.activo }}"
         class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">‚Äπ Anterior</a>
    {% endif %}

    <span class="px-3 py-1">P√°gina {{ pagina.number }} de {{ pagina.paginator.num_pages }}</span>

    {% if pagina.has_next %}
      <a href="?page={{ pagina.next_page_number }}&cantidad={{ cantidad }}&identidad={{ filtros.identidad }}&nombre={{ filtros.nombre }}&email={{ filtros.email }}&rol={{ filtros.rol }}&activo={{ filtros.activo }}"
         class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Siguiente ‚Ä∫</a>
      <a href="?page={{ pagina.paginator.num_pages }}&cantidad={{ cantidad }}&identidad={{ filtros.identidad }}&nombre={{ filtros.nombre }}&email={{ filtros.email }}&rol={{ filtros.rol }}&activo={{ filtros.activo }}"
         class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">√öltimo ¬ª</a>
    {% endif %}
  </div>
</div>

<!-- Modal eliminar -->
<div id="confirmModal" class="fixed inset-0 hidden bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg max-w-sm w-full p-6">
    <h2 class="text-xl font-semibold mb-4">Confirmar eliminaci√≥n</h2>
    <p id="modalMessage" class="mb-6 text-gray-700"></p>
    <div class="flex justify-end space-x-4">
      <button type="button" onclick="closeModal()"
              class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400 font-semibold">
        Cancelar
      </button>

      <form method="POST" action="{% url 'usuarios:user_list' %}">
        {% csrf_token %}
        <input type="hidden" name="user_id" id="modalUserId">
        <button type="submit" name="delete_user" value="1"
                class="px-4 py-2 rounded bg-red-600 hover:bg-red-700 text-white font-semibold">
          Eliminar
        </button>
      </form>
    </div>
  </div>
</div>

<!-- Modal Reset 2FA -->
<div id="reset2FAModal" class="fixed inset-0 hidden bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg max-w-sm w-full p-6">
    <h2 class="text-xl font-semibold mb-4">Resetear 2FA</h2>
    <p id="reset2FAMessage" class="mb-6 text-gray-700"></p>
    <div class="flex justify-end space-x-4">
      <button type="button" onclick="closeReset2FAModal()"
              class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400 font-semibold">
        Cancelar
      </button>

      <form method="POST" action="{% url 'usuarios:user_list' %}">
        {% csrf_token %}
        <input type="hidden" name="user_id" id="reset2FAUserId">
        <button type="submit" name="reset_2fa" value="1"
                class="px-4 py-2 rounded bg-yellow-500 hover:bg-yellow-600 text-white font-semibold">
          Resetear
        </button>
      </form>
    </div>
  </div>
</div>

<script>
  function openModal(userId, email) {
    document.getElementById('confirmModal').classList.remove('hidden');
    document.getElementById('modalMessage').textContent =
      `¬øEst√°s seguro de que deseas eliminar al usuario "${email}"?`;
    document.getElementById('modalUserId').value = userId;
  }
  function closeModal() {
    document.getElementById('confirmModal').classList.add('hidden');
  }

  function openReset2FAModal(userId, email) {
    document.getElementById('reset2FAModal').classList.remove('hidden');
    document.getElementById('reset2FAMessage').textContent =
      `¬øResetear el segundo factor para "${email}"?`;
    document.getElementById('reset2FAUserId').value = userId;
  }
  function closeReset2FAModal() {
    document.getElementById('reset2FAModal').classList.add('hidden');
  }

  (function () {
    const form = document.getElementById('form-filtros');
    if (!form) return;

    const inputs = form.querySelectorAll('input[type="text"]');
    const selects = form.querySelectorAll('select');

    let t;
    inputs.forEach(el => {
      el.addEventListener('input', () => {
        clearTimeout(t);
        t = setTimeout(() => form.requestSubmit(), 700);
      });
      el.addEventListener('keydown', e => {
        if (e.key === 'Enter') { e.preventDefault(); form.requestSubmit(); }
      });
    });

    selects.forEach(el => el.addEventListener('change', () => form.requestSubmit()));
  })();
</script>
{% endblock %}