{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Configurar 2FA - MV Ingeniería</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top,
                  rgba(15,23,42,0.35) 0,
                  transparent 55%),
                  linear-gradient(180deg,#052e26,#0b2a4a);
      min-height: 100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#111827;
    }

    .card {
      background: #ffffff;
      width: 100%;
      max-width: 920px;
      padding: 2.2rem 2rem 1.8rem;
      border-radius: 22px;
      box-shadow:
        0 18px 45px rgba(15,23,42,0.55),
        0 0 0 1px rgba(15,23,42,0.06);
      position: relative;
      overflow: hidden;
    }

    .card::before,
    .card::after {
      content: "";
      position: absolute;
      width: 180px;
      height: 180px;
      border-radius: 50%;
      filter: blur(22px);
      opacity: 0.28;
      z-index: -1;
    }
    .card::before { background: #38bdf8; top:-70px; left:-70px; }
    .card::after  { background: #22c55e; bottom:-70px; right:-70px; }

    .top {
      display:flex;
      flex-direction: column;
      align-items: center;
      text-align:center;
      gap:.35rem;
    }

    .logo-box {
      display: inline-block;
      padding: 8px 10px;
      background: rgba(255,255,255,0.95);
      border-radius: 12px;
      border: 2px solid rgba(56,189,248,0.45);
      box-shadow: 0 6px 14px rgba(15,23,42,0.18);
      margin-bottom: 0.6rem;
    }
    .logo-box img {
      max-width: 165px;
      height: auto;
      display:block;
    }

    h1 {
      margin: 0;
      font-size: 1.6rem;
      font-weight: 900;
      color: #111827;
    }
    .subtitle {
      font-size: .92rem;
      color:#6b7280;
      margin-top: .15rem;
    }

    .messages { margin: 1rem 0 0; width:100%; max-width: 720px; }
    .msg {
      padding:.55rem .75rem;
      border-radius:.7rem;
      font-size:.85rem;
      margin-bottom:.5rem;
    }
    .msg.error{ background:#fee2e2; color:#b91c1c; }
    .msg.success{ background:#ecfdf3; color:#166534; }
    .msg.info{ background:#eff6ff; color:#1d4ed8; }
    .msg.warning{ background:#fffbeb; color:#92400e; }

    .info-banner {
      margin: 1rem auto 1.2rem;
      padding: .8rem .95rem;
      border-radius: .85rem;
      background: #eff6ff;
      color:#1d4ed8;
      font-size:.88rem;
      max-width: 720px;
      text-align:left;
    }

    .grid {
      display:grid;
      grid-template-columns: 1fr;
      gap: 18px;
      margin-top: 1.2rem;
    }
    @media (min-width: 860px){
      .grid { grid-template-columns: 1fr 1fr; }
    }

    .box {
      border: 1px solid #e5e7eb;
      border-radius: 18px;
      padding: 16px;
      background: #fff;
    }
    .box-title {
      font-size: .95rem;
      font-weight: 800;
      color:#111827;
      margin-bottom: .75rem;
    }

    .qr-wrap{
      display:flex;
      flex-direction:column;
      gap: 12px;
      align-items: center;
      justify-content: center;
      padding: 10px 0;
    }
    .qr-img{
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius: 16px;
      padding: 12px;
    }
    .qr-img img{ display:block; max-width: 280px; width:100%; height:auto; }

    code{
      display:block;
      width:100%;
      background:#f8fafc;
      border:1px solid #e5e7eb;
      border-radius: 12px;
      padding: 10px 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: .92rem;
      color:#0f172a;
      word-break: break-all;
    }

    label{
      display:block;
      font-size:.85rem;
      font-weight: 700;
      color:#374151;
      margin-bottom: .35rem;
    }
    input[type="text"]{
      width: 100%;
      padding: .78rem .85rem;
      border-radius: 12px;
      border: 2px solid #d1d5db;
      font-size: 1rem;
      letter-spacing: .22em;
      text-align: center;
      font-weight: 700;
      color:#111827;
    }
    input[type="text"]:focus{
      outline:none;
      border-color:#2563eb;
      box-shadow:0 0 0 1px rgba(37,99,235,0.35);
    }

    .hint{
      margin-top: .4rem;
      font-size: .78rem;
      color:#6b7280;
    }

    button{
      margin-top: 1rem;
      width:100%;
      padding: .85rem;
      border-radius: 999px;
      border:none;
      background: linear-gradient(90deg,#1d4ed8,#2563eb);
      color:#fff;
      font-weight: 800;
      font-size: 1rem;
      cursor:pointer;
      box-shadow:0 10px 22px rgba(37,99,235,.45);
    }
    button:hover{ filter: brightness(1.06); }

    .actions {
      display:flex;
      gap: 10px;
      margin-top: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .btn-link{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: .75rem 1.05rem;
      border-radius: 999px;
      font-weight: 800;
      text-decoration:none;
      border: 1px solid #e5e7eb;
      background:#fff;
      color:#0f172a;
    }
    .btn-link:hover{ background:#f8fafc; }
    .btn-danger{
      background:#fee2e2;
      border-color:#fecaca;
      color:#991b1b;
    }
    .btn-danger:hover{ background:#fecaca; }

    .footer{
      margin-top: 1.1rem;
      font-size: .74rem;
      color:#9ca3af;
      text-align:center;
    }
  </style>
</head>
<body>

  <div class="card">
    <div class="top">
      <div class="logo-box">
        <img src="{% static 'core/images/logo_mv.png' %}" alt="MV Ingeniería">
      </div>

      <h1>Configurar 2FA</h1>
      <div class="subtitle">Escanea el QR con tu app y confirma con el código de 6 dígitos.</div>

      {% if messages %}
        <div class="messages">
          {% for message in messages %}
            <div class="msg {{ message.tags }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}

      {# ✅ Banner SOLO si viene forzado #}
      {% if forced %}
        <div class="info-banner">
          <strong>Por seguridad</strong>, debes activar el segundo factor para continuar usando la plataforma.
        </div>
      {% endif %}

      {# ✅ Escape hatch: que el usuario no quede “atrapado” #}
      <div class="actions">
        <a class="btn-link btn-danger" href="{% url 'usuarios:logout' %}">Cerrar sesión</a>
        <a class="btn-link" href="{% url 'usuarios:login' %}">Volver al login</a>
      </div>
    </div>

    <div class="grid">
      <div class="box">
        <div class="box-title">1. Escanea el código QR</div>

        <div class="qr-wrap">
          <div class="qr-img">
            <img src="{{ qr_data_uri }}" alt="Código QR 2FA">
          </div>
        </div>

        <div class="hint" style="margin-top:.2rem">
          Si no puedes escanear, agrega la cuenta manualmente con este secreto:
        </div>
        <code>{{ secret }}</code>
      </div>

      <div class="box">
        <div class="box-title">2. Verificación</div>

        <form method="post">
          {% csrf_token %}

          <label for="id_token">Código de verificación</label>
          <input
            type="text"
            id="id_token"
            name="token"
            inputmode="numeric"
            autocomplete="one-time-code"
            placeholder="123 456"
            maxlength="10"
            required
          >

          {% if form and form.token and form.token.errors %}
            <div class="msg error" style="margin-top:.7rem">{{ form.token.errors }}</div>
          {% endif %}
          {% if form and form.non_field_errors %}
            <div class="msg error" style="margin-top:.7rem">{{ form.non_field_errors }}</div>
          {% endif %}

          <div class="hint">
            Es el código de 6 dígitos que ves en tu app (Google Authenticator / Microsoft Authenticator).
          </div>

          <button type="submit">Confirmar 2FA</button>
        </form>
      </div>
    </div>

    <div class="footer">MV Ingeniería — Seguridad de cuenta</div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const el = document.getElementById("id_token");
      if (el) el.focus();
    });
  </script>
</body>
</html>