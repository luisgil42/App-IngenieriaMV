{% extends "core/base.html" %}
{% load static %}

{% block title %}Contactos - Finanzas Comercial{% endblock %}

{% block dashboard_content %}
<div class="w-full mx-auto bg-white p-6 rounded-2xl shadow mt-6">

<style>
  .tabla-responsive{
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
    width:100%;
  }
  .tabla-responsive table{
    min-width: 1600px; /* ‚úÖ evita ‚Äúamorchado‚Äù */
    white-space: nowrap;
  }
  .cell-wrap{
    white-space: normal !important;
    word-break: break-word;
  }

  /* ===== Excel header filter ===== */
  .excel-header-btn{
    width:100%;
    justify-content:center;
    font-size:0.875rem;
  }
  .excel-header-btn .excel-arrow{
    font-size:0.65rem;
    margin-left:2px;
  }
  .excel-panel{
    position:fixed;
    z-index:50;
    width:260px;
    background:#fff;
    border-radius:0.75rem;
    border:1px solid #d1d5db;
    box-shadow:0 10px 30px rgba(0,0,0,.15);
    padding:0.75rem;
    font-size:0.8rem;
  }
  .excel-panel .excel-options{
    max-height:180px;
    overflow-y:auto;
    border:1px solid #e5e7eb;
    border-radius:0.5rem;
    padding:0.25rem 0.5rem;
    margin-top:0.25rem;
    background:#f9fafb;
  }
  .excel-col-filtered .excel-header-btn{
    background:#e0f2fe;
    border-radius:999px;
  }
  .excel-col-filtered .excel-arrow{
    color:#2563eb !important;
  }
</style>

<div class="flex flex-wrap items-center justify-between gap-3 mb-4">
  <div>
    <h2 class="text-2xl font-extrabold text-slate-900">Contactos</h2>
    <p class="text-slate-500 text-sm">Listado de contactos comerciales.</p>
  </div>

  <div class="flex items-center gap-2">
    <a href="{% url 'finanzas_comercial:contact_import' %}"
       class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-white border border-slate-200 hover:bg-slate-50 text-slate-800 text-sm font-semibold">
      Importar
    </a>

    <a href="{% url 'finanzas_comercial:contact_export_xlsx' %}?q={{ q|urlencode }}&owner={{ owner_id|urlencode }}&active={{ active|urlencode }}"
       class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-white border border-slate-200 hover:bg-slate-50 text-slate-800 text-sm font-semibold">
      Exportar Excel
    </a>

    <a href="{% url 'finanzas_comercial:contact_create' %}"
       class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold shadow-sm">
      Crear contacto
    </a>
  </div>
</div>

<!-- Selector de columnas + limpiar filtros excel -->
<div class="flex flex-wrap items-center justify-between gap-3 mb-3">
  <details class="relative">
    <summary class="cursor-pointer text-sm text-slate-700 px-3 py-1 border rounded-full bg-white hover:bg-slate-50 select-none">
      ‚öôÔ∏è Columnas
    </summary>
    <div id="columnToggles" class="absolute left-0 mt-1 w-64 bg-white border rounded-xl shadow-lg p-3 z-10">
      <p class="text-xs text-slate-500 mb-2">Mostrar / ocultar columnas</p>

      <label class="flex items-center gap-2 mb-2 pb-2 border-b">
        <input type="checkbox" id="col-toggle-all" checked>
        <span class="font-semibold text-xs">Mostrar todas</span>
      </label>

      <div class="space-y-1 text-sm">
        <label class="flex items-center gap-2"><input type="checkbox" class="col-toggle" data-col="0" checked> <span>Nombre</span></label>
        <label class="flex items-center gap-2"><input type="checkbox" class="col-toggle" data-col="1" checked> <span>Correo</span></label>
        <label class="flex items-center gap-2"><input type="checkbox" class="col-toggle" data-col="2" checked> <span>Tel√©fono</span></label>
        <label class="flex items-center gap-2"><input type="checkbox" class="col-toggle" data-col="3" checked> <span>Empresa</span></label>
        <label class="flex items-center gap-2"><input type="checkbox" class="col-toggle" data-col="4" checked> <span>Cargo</span></label>
        <label class="flex items-center gap-2"><input type="checkbox" class="col-toggle" data-col="5" checked> <span>Propietario</span></label>
        <label class="flex items-center gap-2"><input type="checkbox" class="col-toggle" data-col="6" checked> <span>√öltima actividad</span></label>
        <label class="flex items-center gap-2"><input type="checkbox" class="col-toggle" data-col="7" checked> <span>Creado</span></label>
        <label class="flex items-center gap-2"><input type="checkbox" class="col-toggle" data-col="8" checked> <span>LinkedIn</span></label>
        <label class="flex items-center gap-2"><input type="checkbox" class="col-toggle" data-col="9" checked> <span>Acci√≥n</span></label>
      </div>
    </div>
  </details>

  <button type="button" id="btnExcelClearAll"
          class="px-3 py-1 text-xs border rounded-full bg-white hover:bg-blue-50">
    ‚ùå Limpiar filtros
  </button>
</div>

<div id="zonaTabla">
  <div class="rounded-2xl border border-slate-200 tabla-responsive">
    <table id="tabla-contactos" class="table-auto w-full text-sm">
      <thead class="bg-slate-100 text-slate-800 font-semibold text-center">
        <tr>
          <th class="p-3 border-b border-slate-200" data-excel-col>
            <button type="button" class="excel-header-btn inline-flex items-center gap-1">
              <span>Nombre</span><span class="excel-arrow text-slate-500">‚ñº</span>
            </button>
          </th>
          <th class="p-3 border-b border-slate-200" data-excel-col>
            <button type="button" class="excel-header-btn inline-flex items-center gap-1">
              <span>Correo</span><span class="excel-arrow text-slate-500">‚ñº</span>
            </button>
          </th>
          <th class="p-3 border-b border-slate-200" data-excel-col>
            <button type="button" class="excel-header-btn inline-flex items-center gap-1">
              <span>N√∫mero de tel√©fono</span><span class="excel-arrow text-slate-500">‚ñº</span>
            </button>
          </th>
          <th class="p-3 border-b border-slate-200" data-excel-col>
            <button type="button" class="excel-header-btn inline-flex items-center gap-1">
              <span>Empresa</span><span class="excel-arrow text-slate-500">‚ñº</span>
            </button>
          </th>
          <th class="p-3 border-b border-slate-200" data-excel-col>
            <button type="button" class="excel-header-btn inline-flex items-center gap-1">
              <span>Cargo</span><span class="excel-arrow text-slate-500">‚ñº</span>
            </button>
          </th>
          <th class="p-3 border-b border-slate-200" data-excel-col>
            <button type="button" class="excel-header-btn inline-flex items-center gap-1">
              <span>Propietario</span><span class="excel-arrow text-slate-500">‚ñº</span>
            </button>
          </th>
          <th class="p-3 border-b border-slate-200" data-excel-col>
            <button type="button" class="excel-header-btn inline-flex items-center gap-1">
              <span>√öltima actividad</span><span class="excel-arrow text-slate-500">‚ñº</span>
            </button>
          </th>
          <th class="p-3 border-b border-slate-200" data-excel-col>
            <button type="button" class="excel-header-btn inline-flex items-center gap-1">
              <span>Creado</span><span class="excel-arrow text-slate-500">‚ñº</span>
            </button>
          </th>
          <th class="p-3 border-b border-slate-200" data-excel-col>
            <button type="button" class="excel-header-btn inline-flex items-center gap-1">
              <span>LinkedIn</span><span class="excel-arrow text-slate-500">‚ñº</span>
            </button>
          </th>
          <th class="p-3 border-b border-slate-200">Acci√≥n</th>
        </tr>
      </thead>

      <tbody class="text-center">
        {% for c in pagina %}
        <tr class="border-b border-slate-100 hover:bg-slate-50">
          <!-- Nombre -->
          <td class="p-3 text-left min-w-[320px]"
              data-excel-value="{{ c.full_name|default:'' }}">
            <div class="flex items-center gap-3">
              {% if c.company and c.company.logo %}
                <img src="{{ c.company.logo.url }}" class="w-8 h-8 rounded-lg object-cover border border-slate-200" alt="Logo">
              {% else %}
                <div class="w-8 h-8 rounded-lg bg-slate-100 border border-slate-200 flex items-center justify-center text-xs font-bold text-slate-600">
                  {% if c.company %}{{ c.company.name|slice:":2"|upper }}{% else %}MV{% endif %}
                </div>
              {% endif %}

              <div class="font-semibold text-slate-900">
                {{ c.full_name }}
                {% if not c.is_active %}
                  <span class="ml-2 text-[10px] px-2 py-0.5 rounded-full bg-slate-100 border border-slate-200 text-slate-600">Inactivo</span>
                {% endif %}
              </div>
            </div>
          </td>

          <!-- Correo -->
          <td class="p-3 text-left"
              data-excel-value="{{ c.email|default:'' }}">
            {% if c.email %}{{ c.email }}{% else %}‚Äî{% endif %}
          </td>

          <!-- Tel√©fono -->
          <td class="p-3 text-left"
              data-excel-value="{{ c.phone|default:'' }}">
            {% if c.phone %}{{ c.phone }}{% else %}‚Äî{% endif %}
          </td>

          <!-- Empresa -->
          <td class="p-3 text-left"
              data-excel-value="{% if c.company %}{{ c.company.name }}{% else %}{% endif %}">
            {% if c.company %}{{ c.company.name }}{% else %}‚Äî{% endif %}
          </td>

          <!-- Cargo -->
          <td class="p-3 text-left"
              data-excel-value="{{ c.job_title|default:'' }}">
            {% if c.job_title %}{{ c.job_title }}{% else %}‚Äî{% endif %}
          </td>

          <!-- Propietario -->
          <td class="p-3 text-left"
              data-excel-value="{% if c.owner %}{{ c.owner.get_full_name|default:c.owner.email }}{% else %}{% endif %}">
            {% if c.owner %}{{ c.owner.get_full_name|default:c.owner.email }}{% else %}‚Äî{% endif %}
          </td>

          <!-- √öltima actividad -->
          <td class="p-3 text-left"
              data-excel-value="{% if c.last_activity_at %}{{ c.last_activity_at|date:'d-m-Y H:i' }}{% else %}{% endif %}">
            {% if c.last_activity_at %}{{ c.last_activity_at|date:"d-m-Y H:i" }}{% else %}‚Äî{% endif %}
          </td>

          <!-- Creado -->
          <td class="p-3 text-left"
              data-excel-value="{{ c.created_at|date:'d-m-Y H:i' }}">
            {{ c.created_at|date:"d-m-Y H:i" }}
          </td>

          <!-- LinkedIn -->
          <td class="p-3 text-left"
              data-excel-value="{{ c.linkedin_url|default:'' }}">
            {% if c.linkedin_url %}
              <a href="{{ c.linkedin_url }}" target="_blank" class="text-blue-700 hover:underline font-semibold">Ver</a>
            {% else %}
              <span class="text-slate-400">‚Äî</span>
            {% endif %}
          </td>

          <!-- Acci√≥n -->
          <td class="p-3">
            <div class="inline-flex items-center gap-2 justify-center">
              <a href="{% url 'finanzas_comercial:contact_edit' c.id %}"
                 class="inline-flex items-center px-3 py-1.5 rounded-xl bg-white border border-slate-200 hover:bg-slate-50 text-slate-800 text-sm font-semibold">
                Editar
              </a>

              {% if can_delete %}
                <button
                  type="button"
                  class="inline-flex items-center px-3 py-1.5 rounded-xl bg-red-600 hover:bg-red-700 text-white text-sm font-semibold shadow-sm"
                  data-open-delete="1"
                  data-delete-url="{% url 'finanzas_comercial:contact_delete' c.id %}"
                  data-contact-name="{{ c.full_name|default:'Contacto'|escape }}"
                >
                  Eliminar
                </button>
              {% endif %}
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="10" class="p-6 text-center text-slate-500">
            No hay contactos para mostrar.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Paginaci√≥n + cantidad -->
  <div class="mt-4 flex flex-wrap items-center justify-between gap-3 text-sm">
    <form id="formCantidad" class="flex items-center gap-2">
      <label class="text-sm font-semibold text-slate-700">Mostrar:</label>
      <select name="cantidad" id="cantidad" class="border rounded-xl px-3 py-2 bg-white">
        <option value="5"   {% if cantidad == '5' %}selected{% endif %}>5</option>
        <option value="10"  {% if cantidad == '10' %}selected{% endif %}>10</option>
        <option value="20"  {% if cantidad == '20' %}selected{% endif %}>20</option>
        <option value="50"  {% if cantidad == '50' %}selected{% endif %}>50</option>
        <option value="100" {% if cantidad == '100' %}selected{% endif %}>100</option>
      </select>
    </form>

    <div class="text-slate-600">
      P√°gina {{ pagina.number }} de {{ pagina.paginator.num_pages }}
    </div>

    <div class="flex items-center gap-2">
      {% if pagina.has_previous %}
        <a class="pg-link px-3 py-2 bg-slate-100 rounded-xl hover:bg-slate-200"
           href="?{{ base_qs }}&page=1">¬´ Primero</a>
        <a class="pg-link px-3 py-2 bg-slate-100 rounded-xl hover:bg-slate-200"
           href="?{{ base_qs }}&page={{ pagina.previous_page_number }}">‚Äπ Anterior</a>
      {% endif %}

      {% if pagina.has_next %}
        <a class="pg-link px-3 py-2 bg-slate-100 rounded-xl hover:bg-slate-200"
           href="?{{ base_qs }}&page={{ pagina.next_page_number }}">Siguiente ‚Ä∫</a>
        <a class="pg-link px-3 py-2 bg-slate-100 rounded-xl hover:bg-slate-200"
           href="?{{ base_qs }}&page={{ pagina.paginator.num_pages }}">√öltimo ¬ª</a>
      {% endif %}
    </div>
  </div>
</div>

<!-- Panel flotante tipo Excel -->
<div id="excelFilterPanel" class="excel-panel hidden">
  <h3 id="excelPanelTitle">Columna</h3>
  <small>Filtrar valores</small>

  <div class="mt-2">
    <input id="excelFilterSearch" type="text" placeholder="Buscar..."
           class="w-full border border-slate-300 rounded-md px-2 py-1 text-xs">
  </div>

  <div class="mt-2 excel-options" id="excelFilterOptions"></div>

  <div class="mt-3 flex justify-end gap-2">
    <button type="button" id="excelFilterClearAll" class="px-2 py-1 border rounded-md text-xs">
      Limpiar
    </button>
    <button type="button" id="excelFilterApply" class="px-2 py-1 bg-blue-600 text-white rounded-md text-xs">
      Aplicar
    </button>
  </div>
</div>

<!-- ========================= MODAL ELIMINAR ========================= -->
<div id="deleteModal" class="fixed inset-0 z-[60] hidden">
  <div id="deleteOverlay" class="absolute inset-0 bg-slate-900/40 backdrop-blur-[1px]"></div>
  <div class="relative w-full h-full flex items-center justify-center p-4">
    <div class="w-full max-w-md bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
      <div class="p-5">
        <div class="flex items-start gap-3">
          <div class="w-10 h-10 rounded-xl bg-red-50 border border-red-100 flex items-center justify-center">
            <span class="text-red-600 text-lg">üóëÔ∏è</span>
          </div>
          <div class="flex-1">
            <div class="text-lg font-extrabold text-slate-900">Eliminar contacto</div>
            <div class="text-sm text-slate-600 mt-0.5">
              ¬øSeguro que deseas eliminar a <b id="deleteContactName">este contacto</b>? Esta acci√≥n no se puede deshacer.
            </div>
          </div>
        </div>

        <form id="deleteForm" method="post" class="mt-5">
          {% csrf_token %}
          <div class="flex items-center justify-end gap-2">
            <button type="button" id="btnCancelDelete"
                    class="px-4 py-2 rounded-xl bg-white border border-slate-200 hover:bg-slate-50 text-slate-800 text-sm font-semibold">
              Cancelar
            </button>
            <button type="submit"
                    class="px-4 py-2 rounded-xl bg-red-600 hover:bg-red-700 text-white text-sm font-semibold shadow-sm">
              S√≠, eliminar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const zona = document.getElementById('zonaTabla');
  const table = document.getElementById('tabla-contactos');
  if(!zona || !table) return;

  /* ================== Column visibility ================== */
  const COL_KEY = 'contactCols:' + location.pathname;

  function loadColsState(){
    try{ return JSON.parse(localStorage.getItem(COL_KEY) || '{}') || {}; }catch(_){ return {}; }
  }
  function saveColsState(state){
    try{ localStorage.setItem(COL_KEY, JSON.stringify(state)); }catch(_){}
  }
  function applyColumnVisibility(){
    const state = loadColsState();
    const headerCells = table.querySelectorAll('thead tr th');
    headerCells.forEach((th, idx)=>{
      const visible = state[idx] !== false;
      th.style.display = visible ? '' : 'none';
    });
    table.querySelectorAll('tbody tr').forEach(tr=>{
      const tds = tr.querySelectorAll('td');
      tds.forEach((td, idx)=>{
        const visible = state[idx] !== false;
        td.style.display = visible ? '' : 'none';
      });
    });

    const panel = document.getElementById('columnToggles');
    if(panel){
      const checks = panel.querySelectorAll('.col-toggle');
      const master = panel.querySelector('#col-toggle-all');
      let allOn = true;
      checks.forEach(cb=>{
        const idx = parseInt(cb.dataset.col || '0', 10);
        const visible = state[idx] !== false;
        cb.checked = visible;
        if(!visible) allOn = false;
      });
      if(master) master.checked = allOn;
    }
  }

  function engancharColumnToggles(){
    const panel = document.getElementById('columnToggles');
    if(!panel) return;

    const checks = panel.querySelectorAll('.col-toggle');
    const master = panel.querySelector('#col-toggle-all');

    checks.forEach(cb=>{
      cb.addEventListener('change', ()=>{
        const idx = parseInt(cb.dataset.col || '0', 10);
        const state = loadColsState();
        state[idx] = cb.checked;
        saveColsState(state);
        applyColumnVisibility();
      });
    });

    if(master){
      master.addEventListener('change', ()=>{
        const state = loadColsState();
        const val = master.checked;
        checks.forEach(cb=>{
          const idx = parseInt(cb.dataset.col || '0', 10);
          cb.checked = val;
          state[idx] = val;
        });
        saveColsState(state);
        applyColumnVisibility();
      });
    }
  }

  function initColumnsDropdown(){
    const details = document.querySelector('details.relative');
    if(!details) return;
    document.addEventListener('click', (e)=>{
      if(!details.open) return;
      if(details.contains(e.target)) return;
      details.open = false;
    });
  }

  /* ================== Excel filters (client-side) ================== */
  const excel = {
    panel: document.getElementById('excelFilterPanel'),
    titleEl: document.getElementById('excelPanelTitle'),
    searchInput: document.getElementById('excelFilterSearch'),
    optsBox: document.getElementById('excelFilterOptions'),
    btnApply: document.getElementById('excelFilterApply'),
    btnClearAll: document.getElementById('excelFilterClearAll'),
    headers: Array.from(table.querySelectorAll('thead th')),
    allRows: Array.from(table.querySelector('tbody').rows),
    distinctValues: {},
    activeFilters: loadExcelFilters(),
    currentColIndex: null,
    panelEventsBound: false
  };

  const ACTION_COL_INDEX = 9;

  function loadExcelFilters(){
    try{
      const key = 'contactExcelFilters:' + location.pathname;
      const raw = sessionStorage.getItem(key);
      if(!raw) return {};
      const obj = JSON.parse(raw);
      const result = {};
      Object.entries(obj).forEach(([col, arr])=> result[col] = new Set(arr));
      return result;
    }catch(_){ return {}; }
  }

  function saveExcelFilters(active){
    try{
      const key = 'contactExcelFilters:' + location.pathname;
      const plain = {};
      Object.entries(active).forEach(([col, set])=> plain[col] = Array.from(set));
      sessionStorage.setItem(key, JSON.stringify(plain));
    }catch(_){}
  }

  function excelGetCellValue(td){
    if(!td) return '(Vac√≠as)';
    let text = '';
    if (td.dataset && td.dataset.excelValue){
      text = td.dataset.excelValue;
    } else {
      text = (td.textContent || '');
    }
    text = (text || '').trim();
    return text || '(Vac√≠as)';
  }

  function excelBuildDistinctValues(){
    excel.distinctValues = {};
    excel.allRows.forEach(row=>{
      Array.from(row.cells).forEach((td, idx)=>{
        if(idx === ACTION_COL_INDEX) return;
        if(!excel.distinctValues[idx]) excel.distinctValues[idx] = new Set();
        excel.distinctValues[idx].add(excelGetCellValue(td));
      });
    });
  }

  function excelUpdateHeaderStates(){
    excel.headers.forEach((th, idx)=>{
      if(!th.hasAttribute('data-excel-col')) return;
      const hasFilter = !!(excel.activeFilters[idx] && excel.activeFilters[idx].size > 0);
      th.classList.toggle('excel-col-filtered', hasFilter);
    });
  }

  function excelApplyFilters(){
    excel.allRows.forEach(row=>{
      let visible = true;
      for (const [colIndexStr, values] of Object.entries(excel.activeFilters)){
        const idx = parseInt(colIndexStr, 10);
        if(!values || values.size === 0) continue;
        const cell = row.cells[idx];
        const text = excelGetCellValue(cell);
        if(!values.has(text)){
          visible = false;
          break;
        }
      }
      row.style.display = visible ? '' : 'none';
    });
    excelUpdateHeaderStates();
    saveExcelFilters(excel.activeFilters);
  }

  function excelRenderOptions(colIndex){
    excel.optsBox.innerHTML = '';
    const valuesSet = excel.distinctValues[colIndex] || new Set();
    const values = Array.from(valuesSet).sort((a,b)=>a.localeCompare(b,'es',{sensitivity:'base'}));
    const selected = excel.activeFilters[colIndex];

    const allLabel = document.createElement('label');
    allLabel.className = 'flex items-center gap-1 mb-1 text-xs';
    const allCb = document.createElement('input');
    allCb.type = 'checkbox';
    allCb.checked = !selected || selected.size === values.length;
    allCb.addEventListener('change', ()=>{
      excel.optsBox.querySelectorAll('input[type="checkbox"][data-value]').forEach(cb=> cb.checked = allCb.checked);
    });
    allLabel.appendChild(allCb);
    allLabel.appendChild(document.createTextNode(' (Seleccionar todo)'));
    excel.optsBox.appendChild(allLabel);

    values.forEach(val=>{
      const label = document.createElement('label');
      label.className = 'flex items-center gap-1 text-xs mt-0.5';
      label.dataset.optionLabel = '1';

      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.dataset.value = val;
      cb.checked = !selected || selected.has(val);

      label.appendChild(cb);
      label.appendChild(document.createTextNode(' ' + val));
      excel.optsBox.appendChild(label);
    });
  }

  function excelFilterOptionList(query){
    const q = query.trim().toLowerCase();
    excel.optsBox.querySelectorAll('label[data-option-label]').forEach(lbl=>{
      lbl.style.display = lbl.textContent.toLowerCase().includes(q) ? '' : 'none';
    });
  }

  function excelOpenForHeader(th){
    excel.currentColIndex = parseInt(th.dataset.excelIndex, 10);
    excel.titleEl.textContent = th.innerText.trim();

    excelBuildDistinctValues();
    excelRenderOptions(excel.currentColIndex);

    const rect = th.getBoundingClientRect();
    const panelWidth = 260;
    let left = rect.left + (rect.width - panelWidth) / 2;
    let top  = rect.bottom + 4;
    left = Math.max(8, Math.min(left, window.innerWidth - panelWidth - 8));
    excel.panel.style.left = left + 'px';
    excel.panel.style.top  = top + 'px';

    excel.panel.classList.remove('hidden');
    excel.searchInput.value = '';
    excelFilterOptionList('');
    excel.searchInput.focus();
  }

  function excelBindPanelEventsOnce(){
    if(excel.panelEventsBound) return;

    excel.searchInput.addEventListener('input', ()=> excelFilterOptionList(excel.searchInput.value));

    excel.btnApply.addEventListener('click', ()=>{
      const idx = excel.currentColIndex;
      if(idx == null){ excel.panel.classList.add('hidden'); return; }

      const checks = excel.optsBox.querySelectorAll('input[type="checkbox"][data-value]');
      const selected = new Set();
      checks.forEach(cb=>{ if(cb.checked) selected.add(cb.dataset.value); });

      const fullSet = excel.distinctValues[idx] || new Set();
      if(selected.size === 0 || selected.size === fullSet.size){
        delete excel.activeFilters[idx];
      }else{
        excel.activeFilters[idx] = selected;
      }
      excelApplyFilters();
      excel.panel.classList.add('hidden');
    });

    excel.btnClearAll.addEventListener('click', ()=>{
      const idx = excel.currentColIndex;
      if(idx == null){ excel.panel.classList.add('hidden'); return; }
      delete excel.activeFilters[idx];
      excelApplyFilters();
      excel.panel.classList.add('hidden');
    });

    document.addEventListener('click', (e)=>{
      if(excel.panel.classList.contains('hidden')) return;
      if(excel.panel.contains(e.target)) return;
      if(e.target.closest('.excel-header-btn')) return;
      excel.panel.classList.add('hidden');
    });

    excel.panelEventsBound = true;
  }

  function initExcelFilters(){
    excelBindPanelEventsOnce();
    excel.headers.forEach((th, idx)=>{
      if(th.hasAttribute('data-excel-col')){
        th.dataset.excelIndex = idx;
        const btn = th.querySelector('.excel-header-btn');
        if(btn){
          btn.addEventListener('click', (ev)=>{
            ev.stopPropagation();
            excelOpenForHeader(th);
          });
        }
      }
    });
    excelBuildDistinctValues();
    excelApplyFilters();
  }

  function excelClearAll(){
    excel.activeFilters = {};
    excelApplyFilters();
    excel.panel.classList.add('hidden');
  }

  const btnExcelClearAll = document.getElementById('btnExcelClearAll');
  if(btnExcelClearAll){
    btnExcelClearAll.addEventListener('click', (e)=>{
      e.preventDefault();
      excelClearAll();
    });
  }

  /* ================== cantidad por p√°gina ================== */
  const selCantidad = document.getElementById('cantidad');
  if(selCantidad){
    selCantidad.addEventListener('change', ()=>{
      const params = new URLSearchParams(window.location.search || '');
      params.set('cantidad', selCantidad.value);
      params.set('page', '1');
      window.location.search = params.toString();
    });
  }

  /* ================== Modal eliminar ================== */
  const modal = document.getElementById("deleteModal");
  const overlay = document.getElementById("deleteOverlay");
  const btnCancel = document.getElementById("btnCancelDelete");
  const form = document.getElementById("deleteForm");
  const nameEl = document.getElementById("deleteContactName");

  function openModal(deleteUrl, contactName) {
    if (nameEl) nameEl.textContent = contactName || "este contacto";
    if (form) form.setAttribute("action", deleteUrl || "#");
    modal.classList.remove("hidden");
    document.body.classList.add("overflow-hidden");
  }

  function closeModal() {
    modal.classList.add("hidden");
    document.body.classList.remove("overflow-hidden");
    if (form) form.setAttribute("action", "#");
  }

  document.querySelectorAll("[data-open-delete='1']").forEach((btn) => {
    btn.addEventListener("click", () => {
      const url = btn.getAttribute("data-delete-url");
      const cname = btn.getAttribute("data-contact-name");
      openModal(url, cname);
    });
  });

  overlay && overlay.addEventListener("click", closeModal);
  btnCancel && btnCancel.addEventListener("click", closeModal);

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      if (modal && !modal.classList.contains("hidden")) closeModal();
    }
  });

  /* ================== Init ================== */
  engancharColumnToggles();
  initColumnsDropdown();
  applyColumnVisibility();
  initExcelFilters();
})();
</script>
{% endblock %}