{% extends "core/base.html" %}
{% load humanize %}
{% load static %}
{% load money_cl %}

{% block title %}Cotizaciones - Finanzas Comercial{% endblock %}

{% block dashboard_content %}
<div class="w-full mx-auto bg-white p-6 rounded-2xl shadow mt-6">

<style>
  .tabla-responsive{
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
    width:100%;
  }
  .tabla-responsive table{
    min-width: 1400px;
    white-space: nowrap;
  }
  .cell-wrap{
    white-space: normal !important;
    word-break: break-word;
  }

  .excel-header-btn{
    width:100%;
    justify-content:center;
    font-size:0.875rem;
  }
  .excel-header-btn .excel-arrow{
    font-size:0.65rem;
    margin-left:2px;
  }
  .excel-panel{
    position:fixed;
    z-index:80;
    width:260px;
    background:#fff;
    border-radius:0.75rem;
    border:1px solid #d1d5db;
    box-shadow:0 10px 30px rgba(0,0,0,.15);
    padding:0.75rem;
    font-size:0.8rem;
  }
  .excel-panel .excel-options{
    max-height:180px;
    overflow-y:auto;
    border:1px solid #e5e7eb;
    border-radius:0.5rem;
    padding:0.25rem 0.5rem;
    margin-top:0.25rem;
    background:#f9fafb;
  }
  .excel-col-filtered .excel-header-btn{
    background:#e0f2fe;
    border-radius:999px;
  }
  .excel-col-filtered .excel-arrow{
    color:#2563eb !important;
  }
</style>

<div class="flex flex-wrap items-center justify-between gap-3 mb-4">
  <div>
    <h2 class="text-2xl font-extrabold text-slate-900">Cotizaciones</h2>
    <p class="text-slate-500 text-sm">Listado y gestión rápida de cotizaciones.</p>
  </div>

  <a href="{% url 'finanzas_comercial:quote_create' %}"
     class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold shadow">
    Crear cotización
  </a>
</div>

<div class="flex flex-wrap items-center justify-between gap-3 mb-3">
  <details class="relative">
    <summary class="cursor-pointer text-sm text-slate-700 px-3 py-1 border rounded-full bg-white hover:bg-slate-50 select-none">
      ⚙️ Columnas
    </summary>
    <div id="columnToggles" class="absolute left-0 mt-1 w-64 bg-white border rounded-xl shadow-lg p-3 z-10">
      <p class="text-xs text-slate-500 mb-2">Mostrar / ocultar columnas</p>

      <label class="flex items-center gap-2 mb-2 pb-2 border-b">
        <input type="checkbox" id="col-toggle-all" checked>
        <span class="font-semibold text-xs">Mostrar todas</span>
      </label>

      <div class="space-y-1 text-sm">
        <label class="flex items-center gap-2"><input type="checkbox" class="col-toggle" data-col="0" checked> <span>Título</span></label>
        <label class="flex items-center gap-2"><input type="checkbox" class="col-toggle" data-col="1" checked> <span>Estado</span></label>
        <label class="flex items-center gap-2"><input type="checkbox" class="col-toggle" data-col="2" checked> <span>Comentario</span></label>
        <label class="flex items-center gap-2"><input type="checkbox" class="col-toggle" data-col="3" checked> <span>Importe</span></label>
        <label class="flex items-center gap-2"><input type="checkbox" class="col-toggle" data-col="4" checked> <span>Propietario</span></label>
        <label class="flex items-center gap-2"><input type="checkbox" class="col-toggle" data-col="5" checked> <span>Creación</span></label>
        <label class="flex items-center gap-2"><input type="checkbox" class="col-toggle" data-col="6" checked> <span>Vencimiento</span></label>
        <label class="flex items-center gap-2"><input type="checkbox" class="col-toggle" data-col="7" checked> <span>Negocio</span></label>
        <label class="flex items-center gap-2"><input type="checkbox" class="col-toggle" data-col="8" checked> <span>Contactos</span></label>
        <label class="flex items-center gap-2"><input type="checkbox" class="col-toggle" data-col="9" checked> <span>PDF</span></label>
        <label class="flex items-center gap-2"><input type="checkbox" class="col-toggle" data-col="10" checked> <span>Acción</span></label>
      </div>
    </div>
  </details>

  <button type="button" id="btnExcelClearAll"
          class="px-3 py-1 text-xs border rounded-full bg-white hover:bg-blue-50">
    ❌ Limpiar filtros
  </button>
</div>

<div id="zonaTabla">
  <div class="rounded-2xl border border-slate-200 tabla-responsive">
    <table id="tabla-quotes" class="table-auto w-full text-sm">
      <thead class="bg-slate-100 text-slate-800 font-semibold text-center">
        <tr>
          <th class="p-3 border-b border-slate-200" data-excel-col>
            <button type="button" class="excel-header-btn inline-flex items-center gap-1">
              <span>Título</span><span class="excel-arrow text-slate-500">▼</span>
            </button>
          </th>

          <th class="p-3 border-b border-slate-200" data-excel-col>
            <button type="button" class="excel-header-btn inline-flex items-center gap-1">
              <span>Estado</span><span class="excel-arrow text-slate-500">▼</span>
            </button>
          </th>

          <th class="p-3 border-b border-slate-200" data-excel-col>
            <button type="button" class="excel-header-btn inline-flex items-center gap-1">
              <span>Comentario</span><span class="excel-arrow text-slate-500">▼</span>
            </button>
          </th>

          <th class="p-3 border-b border-slate-200" data-excel-col>
            <button type="button" class="excel-header-btn inline-flex items-center gap-1">
              <span>Importe</span><span class="excel-arrow text-slate-500">▼</span>
            </button>
          </th>

          <th class="p-3 border-b border-slate-200" data-excel-col>
            <button type="button" class="excel-header-btn inline-flex items-center gap-1">
              <span>Propietario</span><span class="excel-arrow text-slate-500">▼</span>
            </button>
          </th>

          <th class="p-3 border-b border-slate-200" data-excel-col>
            <button type="button" class="excel-header-btn inline-flex items-center gap-1">
              <span>Creación</span><span class="excel-arrow text-slate-500">▼</span>
            </button>
          </th>

          <th class="p-3 border-b border-slate-200" data-excel-col>
            <button type="button" class="excel-header-btn inline-flex items-center gap-1">
              <span>Vencimiento</span><span class="excel-arrow text-slate-500">▼</span>
            </button>
          </th>

          <th class="p-3 border-b border-slate-200" data-excel-col>
            <button type="button" class="excel-header-btn inline-flex items-center gap-1">
              <span>Negocio</span><span class="excel-arrow text-slate-500">▼</span>
            </button>
          </th>

          <th class="p-3 border-b border-slate-200" data-excel-col>
            <button type="button" class="excel-header-btn inline-flex items-center gap-1">
              <span>Contactos</span><span class="excel-arrow text-slate-500">▼</span>
            </button>
          </th>

          <th class="p-3 border-b border-slate-200" data-excel-col>
            <button type="button" class="excel-header-btn inline-flex items-center gap-1">
              <span>PDF</span><span class="excel-arrow text-slate-500">▼</span>
            </button>
          </th>

          <th class="p-3 border-b border-slate-200">Acción</th>
        </tr>
      </thead>

      <tbody class="text-center">
        {% for o in pagina.object_list %}
        <tr class="border-b border-slate-100 hover:bg-slate-50">

          <td class="p-3 text-left cell-wrap min-w-[260px]" data-excel-value="{{ o.title|default:'' }}">
            <div class="font-semibold text-slate-900">#{{ o.id }} - {{ o.title }}</div>
          </td>

          <td class="p-3" data-excel-value="{{ o.get_status_display|default:o.status }}">
            <select class="js-status-select border border-slate-200 rounded-xl px-2 py-1 bg-white text-xs font-semibold"
                    data-action="{% url 'finanzas_comercial:quote_update_status' o.pk %}"
                    data-current="{{ o.status }}">
              {% for k,v in status_choices %}
                <option value="{{ k }}" {% if o.status == k %}selected{% endif %}>{{ v }}</option>
              {% endfor %}
            </select>
          </td>

          <td class="p-3 text-left cell-wrap min-w-[240px]" data-excel-value="{{ o.status_comment|default:'' }}">
            {{ o.status_comment|default:"—" }}
          </td>

          <!-- ✅ Importe con moneda -->
          <td class="p-3 font-extrabold text-slate-900">
  {% if o.currency == 'USD' %}US${% else %}${% endif %}
  {% if o.currency == 'USD' %}
    {{ o.amount_clp|money_cl:2 }}
  {% else %}
    {{ o.amount_clp|money_cl:0 }}
  {% endif %}
</td>

          <td class="p-3" data-excel-value="{% if o.owner %}{{ o.owner.get_full_name|default:o.owner.username }}{% else %}{% endif %}">
            {% if o.owner %}
              {{ o.owner.get_full_name|default:o.owner.username }}
            {% else %}
              —
            {% endif %}
          </td>

          <td class="p-3" data-excel-value="{{ o.created_at|date:'d-m-Y' }}">
            {{ o.created_at|date:"d-m-Y" }}
          </td>

          <td class="p-3" data-excel-value="{% if o.expires_at %}{{ o.expires_at|date:'d-m-Y' }}{% else %}—{% endif %}">
            {% if o.expires_at %}{{ o.expires_at|date:"d-m-Y" }}{% else %}—{% endif %}
          </td>

          <td class="p-3" data-excel-value="{% if o.deal %}{{ o.deal.name }}{% else %}—{% endif %}">
            {% if o.deal %}{{ o.deal.name }}{% else %}—{% endif %}
          </td>

          <td class="p-3 text-left cell-wrap min-w-[260px]"
              data-excel-value="{% if o.contacts.all %}{% for c in o.contacts.all %}{{ c.full_name|default:c }}{% if not forloop.last %}, {% endif %}{% endfor %}{% else %}—{% endif %}">
            {% if o.contacts.all %}
              {% for c in o.contacts.all %}
                <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-slate-100 border border-slate-200 text-xs font-semibold mr-1 mb-1">
                  {{ c.full_name|default:c }}
                </span>
              {% endfor %}
            {% else %}
              —
            {% endif %}
          </td>

          <td class="p-3" data-excel-value="{% if o.pdf_file %}Sí{% else %}No{% endif %}">
            {% if o.pdf_file %}
              <a href="{% url 'finanzas_comercial:quote_pdf_download' o.pk %}"
                 class="px-3 py-1.5 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-semibold inline-flex items-center gap-2">
                Descargar
              </a>
            {% else %}
              —
            {% endif %}
          </td>

          <td class="p-3">
            <div class="flex items-center justify-center gap-2">
              <a href="{% url 'finanzas_comercial:quote_edit' o.pk %}"
                 class="px-3 py-1.5 rounded-xl bg-white border border-slate-200 hover:bg-slate-50 text-slate-800 text-xs font-semibold">
                Editar
              </a>

              <form method="post" action="{% url 'finanzas_comercial:quote_delete' o.pk %}"
      class="js-delete-quote"
      data-quote-id="{{ o.id }}"
      data-quote-title="{{ o.title|default:''|escape }}">
  {% csrf_token %}
  <button type="submit"
          class="px-3 py-1.5 rounded-xl bg-red-600 hover:bg-red-700 text-white text-xs font-semibold">
    Eliminar
  </button>
</form>

              <a href="{% url 'finanzas_comercial:quote_duplicate' o.pk %}"
                 class="px-3 py-1.5 rounded-xl bg-white border border-slate-200 hover:bg-slate-50 text-slate-800 text-xs font-semibold">
                Duplicar
              </a>
            </div>
          </td>
        </tr>

        {% empty %}
        <tr>
          <td colspan="11" class="p-6 text-center text-slate-500">
            No hay cotizaciones para mostrar.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Paginación + cantidad -->
  <div class="mt-4 flex flex-wrap items-center justify-between gap-3 text-sm">
    <form id="formCantidad" class="flex items-center gap-2">
      <label class="text-sm font-semibold text-slate-700">Mostrar:</label>
      <select name="cantidad" id="cantidad" class="border rounded-xl px-3 py-2 bg-white">
        <option value="5"   {% if cantidad == '5' %}selected{% endif %}>5</option>
        <option value="10"  {% if cantidad == '10' %}selected{% endif %}>10</option>
        <option value="20"  {% if cantidad == '20' %}selected{% endif %}>20</option>
        <option value="50"  {% if cantidad == '50' %}selected{% endif %}>50</option>
        <option value="100" {% if cantidad == '100' %}selected{% endif %}>100</option>
      </select>
    </form>

    <div class="text-slate-600">
      Página {{ pagina.number }} de {{ pagina.paginator.num_pages }}
    </div>

    <div class="flex items-center gap-2">
      {% if pagina.has_previous %}
        <a class="pg-link px-3 py-2 bg-slate-100 rounded-xl hover:bg-slate-200"
           href="?{{ base_qs }}&page=1">« Primero</a>
        <a class="pg-link px-3 py-2 bg-slate-100 rounded-xl hover:bg-slate-200"
           href="?{{ base_qs }}&page={{ pagina.previous_page_number }}">‹ Anterior</a>
      {% endif %}
      {% if pagina.has_next %}
        <a class="pg-link px-3 py-2 bg-slate-100 rounded-xl hover:bg-slate-200"
           href="?{{ base_qs }}&page={{ pagina.next_page_number }}">Siguiente ›</a>
        <a class="pg-link px-3 py-2 bg-slate-100 rounded-xl hover:bg-slate-200"
           href="?{{ base_qs }}&page={{ pagina.paginator.num_pages }}">Último »</a>
      {% endif %}
    </div>
  </div>
</div>

<!-- Panel flotante tipo Excel -->
<div id="excelFilterPanel" class="excel-panel hidden">
  <h3 id="excelPanelTitle">Columna</h3>
  <small>Filtrar valores</small>

  <div class="mt-2">
    <input id="excelFilterSearch" type="text" placeholder="Buscar..."
           class="w-full border border-slate-300 rounded-md px-2 py-1 text-xs">
  </div>

  <div class="mt-2 excel-options" id="excelFilterOptions"></div>

  <div class="mt-3 flex justify-end gap-2">
    <button type="button" id="excelFilterClearAll" class="px-2 py-1 border rounded-md text-xs">
      Limpiar
    </button>
    <button type="button" id="excelFilterApply" class="px-2 py-1 bg-blue-600 text-white rounded-md text-xs">
      Aplicar
    </button>
  </div>
</div>

<!-- Modal comentario status (igual) -->
<div id="statusModal" class="hidden fixed inset-0 z-[120]">
  <div class="absolute inset-0 bg-black/40"></div>

  <div class="relative w-full h-full flex items-center justify-center p-4">
    <div class="w-full max-w-lg bg-white rounded-3xl shadow-2xl border border-slate-200 overflow-hidden">
      <div class="px-5 py-4 border-b border-slate-200 flex items-center justify-between">
        <div>
          <div class="text-lg font-extrabold text-slate-900">Comentario</div>
          <div id="statusModalSub" class="text-xs text-slate-500 -mt-0.5">Opcional</div>
        </div>
        <button id="statusModalClose"
                class="inline-flex items-center justify-center w-10 h-10 rounded-xl hover:bg-slate-100">
          ✕
        </button>
      </div>

      <div class="p-5">
        <label class="text-xs font-semibold text-slate-600">Escribe un comentario (opcional)</label>
        <textarea id="statusModalText"
                  class="w-full mt-2 min-h-[120px] px-3 py-2 rounded-2xl border border-slate-200 bg-slate-50 focus:bg-white focus:outline-none text-sm"
                  placeholder="Ej: Cliente pidió ajustar condiciones, esperando confirmación..."></textarea>

        <div class="mt-4 flex items-center justify-end gap-2">
          <button id="statusModalCancel"
                  class="px-4 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 font-semibold">
            Cancelar
          </button>
          <button id="statusModalOk"
                  class="px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-extrabold">
            Guardar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- ✅ Modal eliminar cotización -->
<div id="deleteModal" class="hidden fixed inset-0 z-[140]">
  <div class="absolute inset-0 bg-black/50"></div>

  <div class="relative w-full h-full flex items-center justify-center p-4">
    <div class="w-full max-w-md bg-white rounded-3xl shadow-2xl border border-slate-200 overflow-hidden">
      <div class="px-5 py-4 border-b border-slate-200 flex items-start justify-between gap-3">
        <div class="flex items-start gap-3">
          <div class="w-10 h-10 rounded-2xl bg-red-50 border border-red-200 flex items-center justify-center">
            <span class="text-red-700 text-lg">!</span>
          </div>
          <div>
            <div class="text-lg font-extrabold text-slate-900">Eliminar cotización</div>
            <div class="text-xs text-slate-500 -mt-0.5">Esta acción no se puede deshacer.</div>
          </div>
        </div>

        <button id="deleteModalClose"
                class="inline-flex items-center justify-center w-10 h-10 rounded-xl hover:bg-slate-100">
          ✕
        </button>
      </div>

      <div class="p-5">
        <div class="text-sm text-slate-700">
          ¿Seguro que quieres eliminar la cotización
          <span class="font-extrabold text-slate-900" id="deleteModalQuoteLabel">#—</span>?
        </div>

        <div class="mt-4 flex items-center justify-end gap-2">
          <button type="button" id="deleteModalCancel"
                  class="px-4 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 font-semibold">
            Cancelar
          </button>

          <button type="button" id="deleteModalOk"
                  class="px-4 py-2 rounded-xl bg-red-600 hover:bg-red-700 text-white font-extrabold">
            Eliminar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>


</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const zona = document.getElementById('zonaTabla');
  const table = document.getElementById('tabla-quotes');
  if(!zona || !table) return;

  const COL_KEY = 'quoteCols:' + location.pathname;

  function loadColsState(){
    try{ return JSON.parse(localStorage.getItem(COL_KEY) || '{}') || {}; }catch(_){ return {}; }
  }
  function saveColsState(state){
    try{ localStorage.setItem(COL_KEY, JSON.stringify(state)); }catch(_){}
  }
  function applyColumnVisibility(){
    const state = loadColsState();
    const headerCells = table.querySelectorAll('thead tr th');
    headerCells.forEach((th, idx)=>{
      const visible = state[idx] !== false;
      th.style.display = visible ? '' : 'none';
    });
    table.querySelectorAll('tbody tr').forEach(tr=>{
      const tds = tr.querySelectorAll('td');
      tds.forEach((td, idx)=>{
        const visible = state[idx] !== false;
        td.style.display = visible ? '' : 'none';
      });
    });

    const panel = document.getElementById('columnToggles');
    if(panel){
      const checks = panel.querySelectorAll('.col-toggle');
      const master = panel.querySelector('#col-toggle-all');
      let allOn = true;
      checks.forEach(cb=>{
        const idx = parseInt(cb.dataset.col || '0', 10);
        const visible = state[idx] !== false;
        cb.checked = visible;
        if(!visible) allOn = false;
      });
      if(master) master.checked = allOn;
    }
  }

  function engancharColumnToggles(){
    const panel = document.getElementById('columnToggles');
    if(!panel) return;

    const checks = panel.querySelectorAll('.col-toggle');
    const master = panel.querySelector('#col-toggle-all');

    checks.forEach(cb=>{
      cb.addEventListener('change', ()=>{
        const idx = parseInt(cb.dataset.col || '0', 10);
        const state = loadColsState();
        state[idx] = cb.checked;
        saveColsState(state);
        applyColumnVisibility();
      });
    });

    if(master){
      master.addEventListener('change', ()=>{
        const state = loadColsState();
        const val = master.checked;
        checks.forEach(cb=>{
          const idx = parseInt(cb.dataset.col || '0', 10);
          cb.checked = val;
          state[idx] = val;
        });
        saveColsState(state);
        applyColumnVisibility();
      });
    }
  }

  function initColumnsDropdown(){
    const details = document.querySelector('details.relative');
    if(!details) return;
    document.addEventListener('click', (e)=>{
      if(!details.open) return;
      if(details.contains(e.target)) return;
      details.open = false;
    });
  }

  const excel = {
    panel: document.getElementById('excelFilterPanel'),
    titleEl: document.getElementById('excelPanelTitle'),
    searchInput: document.getElementById('excelFilterSearch'),
    optsBox: document.getElementById('excelFilterOptions'),
    btnApply: document.getElementById('excelFilterApply'),
    btnClearAll: document.getElementById('excelFilterClearAll'),
    headers: Array.from(table.querySelectorAll('thead th')),
    allRows: Array.from(table.querySelector('tbody').rows),
    distinctValues: {},
    activeFilters: loadExcelFilters(),
    currentColIndex: null,
    panelEventsBound: false
  };

  function loadExcelFilters(){
    try{
      const key = 'quoteExcelFilters:' + location.pathname;
      const raw = sessionStorage.getItem(key);
      if(!raw) return {};
      const obj = JSON.parse(raw);
      const result = {};
      Object.entries(obj).forEach(([col, arr])=> result[col] = new Set(arr));
      return result;
    }catch(_){ return {}; }
  }

  function saveExcelFilters(active){
    try{
      const key = 'quoteExcelFilters:' + location.pathname;
      const plain = {};
      Object.entries(active).forEach(([col, set])=> plain[col] = Array.from(set));
      sessionStorage.setItem(key, JSON.stringify(plain));
    }catch(_){}
  }

  function excelGetCellValue(td){
    if(!td) return '(Vacías)';
    let text = '';
    if (td.dataset && td.dataset.excelValue){
      text = td.dataset.excelValue;
    } else {
      text = (td.textContent || '');
    }
    text = (text || '').trim();
    return text || '(Vacías)';
  }

  function excelBuildDistinctValues(){
    excel.distinctValues = {};
    excel.allRows.forEach(row=>{
      Array.from(row.cells).forEach((td, idx)=>{
        if(idx === 10) return;
        if(!excel.distinctValues[idx]) excel.distinctValues[idx] = new Set();
        excel.distinctValues[idx].add(excelGetCellValue(td));
      });
    });
  }

  function excelUpdateHeaderStates(){
    excel.headers.forEach((th, idx)=>{
      if(!th.hasAttribute('data-excel-col')) return;
      const hasFilter = !!(excel.activeFilters[idx] && excel.activeFilters[idx].size > 0);
      th.classList.toggle('excel-col-filtered', hasFilter);
    });
  }

  function excelApplyFilters(){
    excel.allRows.forEach(row=>{
      let visible = true;
      for (const [colIndexStr, values] of Object.entries(excel.activeFilters)){
        const idx = parseInt(colIndexStr, 10);
        if(!values || values.size === 0) continue;
        const cell = row.cells[idx];
        const text = excelGetCellValue(cell);
        if(!values.has(text)){
          visible = false;
          break;
        }
      }
      row.style.display = visible ? '' : 'none';
    });
    excelUpdateHeaderStates();
    saveExcelFilters(excel.activeFilters);
  }

  function excelRenderOptions(colIndex){
    excel.optsBox.innerHTML = '';
    const valuesSet = excel.distinctValues[colIndex] || new Set();
    const values = Array.from(valuesSet).sort((a,b)=>a.localeCompare(b,'es',{sensitivity:'base'}));
    const selected = excel.activeFilters[colIndex];

    const allLabel = document.createElement('label');
    allLabel.className = 'flex items-center gap-1 mb-1 text-xs';
    const allCb = document.createElement('input');
    allCb.type = 'checkbox';
    allCb.checked = !selected || selected.size === values.length;
    allCb.addEventListener('change', ()=>{
      excel.optsBox.querySelectorAll('input[type="checkbox"][data-value]').forEach(cb=> cb.checked = allCb.checked);
    });
    allLabel.appendChild(allCb);
    allLabel.appendChild(document.createTextNode(' (Seleccionar todo)'));
    excel.optsBox.appendChild(allLabel);

    values.forEach(val=>{
      const label = document.createElement('label');
      label.className = 'flex items-center gap-1 text-xs mt-0.5';
      label.dataset.optionLabel = '1';

      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.dataset.value = val;
      cb.checked = !selected || selected.has(val);

      label.appendChild(cb);
      label.appendChild(document.createTextNode(' ' + val));
      excel.optsBox.appendChild(label);
    });
  }

  function excelFilterOptionList(query){
    const q = query.trim().toLowerCase();
    excel.optsBox.querySelectorAll('label[data-option-label]').forEach(lbl=>{
      lbl.style.display = lbl.textContent.toLowerCase().includes(q) ? '' : 'none';
    });
  }

  function excelOpenForHeader(th){
    excel.currentColIndex = parseInt(th.dataset.excelIndex, 10);
    excel.titleEl.textContent = th.innerText.trim();

    excelBuildDistinctValues();
    excelRenderOptions(excel.currentColIndex);

    const rect = th.getBoundingClientRect();
    const panelWidth = 260;
    let left = rect.left + (rect.width - panelWidth) / 2;
    let top  = rect.bottom + 4;
    left = Math.max(8, Math.min(left, window.innerWidth - panelWidth - 8));
    excel.panel.style.left = left + 'px';
    excel.panel.style.top  = top + 'px';

    excel.panel.classList.remove('hidden');
    excel.searchInput.value = '';
    excelFilterOptionList('');
    excel.searchInput.focus();
  }

  function excelBindPanelEventsOnce(){
    if(excel.panelEventsBound) return;

    excel.searchInput.addEventListener('input', ()=> excelFilterOptionList(excel.searchInput.value));

    excel.btnApply.addEventListener('click', ()=>{
      const idx = excel.currentColIndex;
      if(idx == null){ excel.panel.classList.add('hidden'); return; }

      const checks = excel.optsBox.querySelectorAll('input[type="checkbox"][data-value]');
      const selected = new Set();
      checks.forEach(cb=>{ if(cb.checked) selected.add(cb.dataset.value); });

      const fullSet = excel.distinctValues[idx] || new Set();
      if(selected.size === 0 || selected.size === fullSet.size){
        delete excel.activeFilters[idx];
      }else{
        excel.activeFilters[idx] = selected;
      }
      excelApplyFilters();
      excel.panel.classList.add('hidden');
    });

    excel.btnClearAll.addEventListener('click', ()=>{
      const idx = excel.currentColIndex;
      if(idx == null){ excel.panel.classList.add('hidden'); return; }
      delete excel.activeFilters[idx];
      excelApplyFilters();
      excel.panel.classList.add('hidden');
    });

    document.addEventListener('click', (e)=>{
      if(excel.panel.classList.contains('hidden')) return;
      if(excel.panel.contains(e.target)) return;
      if(e.target.closest('.excel-header-btn')) return;
      excel.panel.classList.add('hidden');
    });

    excel.panelEventsBound = true;
  }

  function initExcelFilters(){
    excelBindPanelEventsOnce();
    excel.headers.forEach((th, idx)=>{
      if(th.hasAttribute('data-excel-col')){
        th.dataset.excelIndex = idx;
        const btn = th.querySelector('.excel-header-btn');
        if(btn){
          btn.addEventListener('click', (ev)=>{
            ev.stopPropagation();
            excelOpenForHeader(th);
          });
        }
      }
    });
    excelBuildDistinctValues();
    excelApplyFilters();
  }

  function excelClearAll(){
    excel.activeFilters = {};
    excelApplyFilters();
    excel.panel.classList.add('hidden');
  }

  const btnExcelClearAll = document.getElementById('btnExcelClearAll');
  if(btnExcelClearAll){
    btnExcelClearAll.addEventListener('click', (e)=>{
      e.preventDefault();
      excelClearAll();
    });
  }

  function getCookie(name){
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return "";
  }
  function getCsrfToken(){
    const inp = document.querySelector('input[name="csrfmiddlewaretoken"]');
    return (inp && inp.value) ? inp.value : getCookie("csrftoken");
  }

  const modal = document.getElementById("statusModal");
  const modalText = document.getElementById("statusModalText");
  const modalClose = document.getElementById("statusModalClose");
  const modalCancel = document.getElementById("statusModalCancel");
  const modalOk = document.getElementById("statusModalOk");
  const modalSub = document.getElementById("statusModalSub");

  let currentSelect = null;
  let pendingNext = null;
  let pendingPrev = null;

  function openModal(selectEl, prev, next){
    currentSelect = selectEl;
    pendingPrev = prev;
    pendingNext = next;
    modalText.value = "";
    modalSub.textContent = "Comentario opcional (se guardará si lo escribes)";
    modal.classList.remove("hidden");
    setTimeout(()=> modalText.focus(), 50);
  }
  function closeModal(){
    modal.classList.add("hidden");
    currentSelect = null;
    pendingNext = null;
    pendingPrev = null;
  }

  modalClose && modalClose.addEventListener("click", closeModal);
  modalCancel && modalCancel.addEventListener("click", ()=>{
    if(currentSelect) currentSelect.value = pendingPrev;
    closeModal();
  });

  modal && modal.addEventListener("click", (e)=>{
    if(e.target === modal) return;
    if(e.target.classList && e.target.classList.contains("bg-black/40")){
      if(currentSelect) currentSelect.value = pendingPrev;
      closeModal();
    }
  });

  async function sendStatus(selectEl, prev, next, comment){
    const action = selectEl.dataset.action || "";
    const csrf = getCsrfToken();
    if(!action){
      selectEl.value = prev;
      return;
    }

    try{
      const body = new URLSearchParams();
      body.set("status", next);
      body.set("comment", (comment || "").trim());

      const resp = await fetch(action, {
        method: "POST",
        credentials: "same-origin",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
          "X-CSRFToken": csrf,
          "X-Requested-With": "XMLHttpRequest",
        },
        body: body.toString(),
      });

      if(!resp.ok) throw new Error("HTTP " + resp.status);

      selectEl.dataset.current = next;
      window.location.reload();
    }catch(err){
      console.error(err);
      alert("No se pudo actualizar el estado. Revisa consola / red.");
      selectEl.value = prev;
    }
  }

  function bindInlineStatus(){
    table.querySelectorAll(".js-status-select").forEach(sel=>{
      sel.addEventListener("click", (e)=> e.stopPropagation());

      sel.addEventListener("change", async ()=>{
        const prev = sel.dataset.current || "";
        const next = sel.value;
        openModal(sel, prev, next);
      });
    });
  }

  modalOk && modalOk.addEventListener("click", async ()=>{
    if(!currentSelect) return;
    const comment = (modalText.value || "").trim();
    const sel = currentSelect;
    const prev = pendingPrev;
    const next = pendingNext;
    closeModal();
    await sendStatus(sel, prev, next, comment);
  });

  engancharColumnToggles();
  initColumnsDropdown();
  applyColumnVisibility();
  initExcelFilters();
  bindInlineStatus();
})();


  // =========================
  // ✅ Modal bonito: Eliminar cotización
  // =========================
  const deleteModal = document.getElementById("deleteModal");
  const deleteModalClose = document.getElementById("deleteModalClose");
  const deleteModalCancel = document.getElementById("deleteModalCancel");
  const deleteModalOk = document.getElementById("deleteModalOk");
  const deleteModalQuoteLabel = document.getElementById("deleteModalQuoteLabel");

  let _pendingDeleteForm = null;

  function openDeleteModal(formEl){
    _pendingDeleteForm = formEl;

    const qid = formEl.dataset.quoteId || "";
    const qtitle = formEl.dataset.quoteTitle || "";
    deleteModalQuoteLabel.textContent = `#${qid} - ${qtitle}`.trim();

    deleteModal.classList.remove("hidden");
    setTimeout(()=> deleteModalOk && deleteModalOk.focus(), 50);
  }

  function closeDeleteModal(){
    deleteModal.classList.add("hidden");
    _pendingDeleteForm = null;
  }

  function bindDeleteButtons(){
    document.querySelectorAll("form.js-delete-quote").forEach(formEl=>{
      if(formEl.dataset.boundDelete === "1") return;
      formEl.dataset.boundDelete = "1";

      formEl.addEventListener("submit", (e)=>{
        e.preventDefault();
        openDeleteModal(formEl);
      });
    });
  }

  deleteModalClose && deleteModalClose.addEventListener("click", closeDeleteModal);
  deleteModalCancel && deleteModalCancel.addEventListener("click", closeDeleteModal);

  // click fuera
  deleteModal && deleteModal.addEventListener("click", (e)=>{
    if(e.target === deleteModal) return;
    if(e.target.classList && e.target.classList.contains("bg-black/50")){
      closeDeleteModal();
    }
  });

  // ESC
  document.addEventListener("keydown", (e)=>{
    if(deleteModal.classList.contains("hidden")) return;
    if(e.key === "Escape") closeDeleteModal();
  });

  deleteModalOk && deleteModalOk.addEventListener("click", ()=>{
    if(!_pendingDeleteForm) return;
    // evita doble submit
    deleteModalOk.disabled = true;
    _pendingDeleteForm.submit();
  });

  // enganchar al inicio
  bindDeleteButtons();
</script>
{% endblock %}