{% extends "core/base.html" %}
{% load static %}

{% block title %}{{ title }} - Finanzas Comercial{% endblock %}

{% block dashboard_content %}
<div class="max-w-[900px] mx-auto">
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-extrabold text-slate-900">{{ title }}</h1>
      <p class="text-sm text-slate-500">Completa los datos del negocio.</p>
    </div>
    <a href="{% url 'finanzas_comercial:deal_list' %}"
       class="px-4 py-2 rounded-xl bg-white border border-slate-200 hover:bg-slate-50 text-slate-800 text-sm font-semibold">
      Volver
    </a>
  </div>

  <div class="mt-4 bg-white border border-slate-200 rounded-2xl p-5">
    <form method="post" enctype="multipart/form-data" class="space-y-4">
      {% csrf_token %}

      <div>
        <label class="text-xs font-semibold text-slate-600">Nombre del negocio</label>
        {{ form.name }}
      </div>

      {% if is_edit %}
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-xs font-semibold text-slate-600">Etapa</label>
          {{ form.stage }}
        </div>
        <div>
          <label class="text-xs font-semibold text-slate-600">Fecha de cierre</label>
          {{ form.close_at }}
          <div class="text-[11px] text-slate-500 mt-1">Formato: fecha y hora.</div>
        </div>
      </div>
      {% else %}
      <div>
        <label class="text-xs font-semibold text-slate-600">Fecha de cierre</label>
        {{ form.close_at }}
        <div class="text-[11px] text-slate-500 mt-1">Formato: fecha y hora.</div>
      </div>
      {% endif %}

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-xs font-semibold text-slate-600">Empresa</label>
          {{ form.company }}
        </div>
        <div>
          <label class="text-xs font-semibold text-slate-600">Propietario</label>
          {{ form.owner }}
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-xs font-semibold text-slate-600">Valor</label>
          {{ form.value }}
        </div>
        <div class="flex items-end">
          <label class="inline-flex items-center gap-2 text-sm text-slate-700">
            {{ form.is_active }}
            Activo
          </label>
        </div>
      </div>

      <!-- ✅ Adjuntos iniciales (INICIAL / sin analizar) -->
      <div>
        <label class="text-xs font-semibold text-slate-600">Adjuntar documentos (RFP / entrada)</label>

        <div id="attachmentsBox" class="mt-1 space-y-2">
          <input type="file" name="initial_attachments" multiple
                 class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-white" />
        </div>

        <button type="button" id="btnAddAttachment"
                class="mt-2 inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-white border border-slate-200 hover:bg-slate-50 text-slate-800 text-sm font-semibold">
          + Agregar otra línea de carga
        </button>

        <div class="text-xs text-slate-500 mt-1">Los archivos se guardan en Wasabi</div>

        {% if is_edit and obj %}
          <div class="border-t border-slate-200 mt-4 pt-4">
            <div class="text-sm font-semibold text-slate-800 mb-2">Adjuntos actuales (RFP / entrada)</div>

            {% if initial_existing and initial_existing|length > 0 %}
              <ul class="space-y-2">
                {% for a in initial_existing %}
                  <li class="flex items-center justify-between gap-3 p-3 rounded-xl border border-slate-200 bg-slate-50">
                    <div class="text-sm text-slate-800 min-w-0">
                      <div class="truncate">
                        {{ a.original_name|default:a.file.name }}
                      </div>
                      <div class="text-xs text-slate-500">{{ a.uploaded_at|date:"d-m-Y H:i" }}</div>
                    </div>

                    <div class="flex items-center gap-2 shrink-0">
                      <a href="{{ a.file.url }}" target="_blank"
                         class="inline-flex items-center px-3 py-1.5 rounded-xl bg-white border border-slate-200 hover:bg-slate-50 text-slate-800 text-sm font-semibold">
                        Ver
                      </a>

                      <form method="post"
                            action="{% url 'finanzas_comercial:deal_attachment_delete' a.id %}"
                            onsubmit="return confirm('¿Eliminar este adjunto?');">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ request.get_full_path }}">
                        <button type="submit"
                                class="inline-flex items-center px-3 py-1.5 rounded-xl bg-red-600 hover:bg-red-700 text-white text-sm font-semibold">
                          Eliminar
                        </button>
                      </form>
                    </div>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <div class="text-sm text-slate-500">Sin adjuntos.</div>
            {% endif %}
          </div>
        {% endif %}
      </div>

      <div class="flex justify-end gap-2 pt-2">
        <button class="px-5 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold shadow-sm">
          Guardar
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll("input, select, textarea").forEach((el)=>{
      el.classList.add("mt-1","w-full","px-3","py-2","rounded-xl","border","border-slate-200");
      el.classList.add("focus:outline-none","focus:ring-2","focus:ring-blue-200");
    });

    const box = document.getElementById("attachmentsBox");
    const btn = document.getElementById("btnAddAttachment");
    if (box && btn) {
      btn.addEventListener("click", () => {
        const input = document.createElement("input");
        input.type = "file";
        input.name = "initial_attachments";
        input.className = "w-full px-3 py-2 rounded-xl border border-slate-200 bg-white";
        box.appendChild(input);
      });
    }
  });
</script>
{% endblock %}