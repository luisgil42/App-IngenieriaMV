{% extends "core/base.html" %}
{% block title %}Dashboard - MV{% endblock %}

{% block dashboard_content %}
<div class="max-w-7xl mx-auto space-y-6">

  
  <!-- Header -->
<div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-3">
  <div>
    <h1 class="text-2xl md:text-3xl font-extrabold text-slate-900">Dashboard Comercial</h1>
    <p class="text-slate-600 mt-1">Resumen ejecutivo de negocios y cotizaciones.</p>
  </div>
</div>

  <!-- KPIs -->
  <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">

    <div class="rounded-3xl bg-white border border-slate-200 p-5 shadow-sm">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-sm text-slate-500 font-semibold">Negocios (Total)</div>
          <div class="text-3xl font-extrabold text-slate-900 mt-1">{{ deals_total|default:0 }}</div>
          <div class="text-xs text-slate-500 mt-1">Todos los negocios registrados</div>
        </div>
        <div class="w-11 h-11 rounded-2xl bg-blue-50 border border-blue-100 flex items-center justify-center">
          <i data-lucide="briefcase-business" class="w-5 h-5 text-blue-700"></i>
        </div>
      </div>
    </div>

    <div class="rounded-3xl bg-white border border-slate-200 p-5 shadow-sm">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-sm text-slate-500 font-semibold">Negocios (En proceso)</div>
          <div class="text-3xl font-extrabold text-slate-900 mt-1">{{ deals_in_progress|default:0 }}</div>
          <div class="text-xs text-slate-500 mt-1">Activos / abiertos</div>
        </div>
        <div class="w-11 h-11 rounded-2xl bg-amber-50 border border-amber-100 flex items-center justify-center">
          <i data-lucide="activity" class="w-5 h-5 text-amber-700"></i>
        </div>
      </div>
    </div>

    <div class="rounded-3xl bg-white border border-slate-200 p-5 shadow-sm">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-sm text-slate-500 font-semibold">Negocios (Cerrados)</div>
          <div class="text-3xl font-extrabold text-slate-900 mt-1">{{ deals_closed|default:0 }}</div>
          <div class="text-xs text-slate-500 mt-1">Ganados / Perdidos / Finalizados</div>
        </div>
        <div class="w-11 h-11 rounded-2xl bg-emerald-50 border border-emerald-100 flex items-center justify-center">
          <i data-lucide="check-circle-2" class="w-5 h-5 text-emerald-700"></i>
        </div>
      </div>
    </div>

    <div class="rounded-3xl bg-white border border-slate-200 p-5 shadow-sm">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-sm text-slate-500 font-semibold">Cotizaciones (Total)</div>
          <div class="text-3xl font-extrabold text-slate-900 mt-1">{{ quotes_total|default:0 }}</div>
          <div class="text-xs text-slate-500 mt-1">
            En proceso: <span class="font-semibold">{{ quotes_in_progress|default:0 }}</span> ·
            Cerradas: <span class="font-semibold">{{ quotes_closed|default:0 }}</span>
          </div>
        </div>
        <div class="w-11 h-11 rounded-2xl bg-purple-50 border border-purple-100 flex items-center justify-center">
          <i data-lucide="file-text" class="w-5 h-5 text-purple-700"></i>
        </div>
      </div>
    </div>

  </div>

  <!-- Charts -->
  <div class="grid grid-cols-1 xl:grid-cols-5 gap-4">

    <!-- Donut Negocios -->
    <div class="xl:col-span-2 rounded-3xl bg-white border border-slate-200 shadow-sm overflow-hidden">
      <div class="p-5 border-b border-slate-200">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-lg font-extrabold text-slate-900">Negocios</div>
            <div class="text-sm text-slate-600">Distribución: en proceso vs cerrados</div>
          </div>
          <div class="w-10 h-10 rounded-2xl bg-slate-50 border border-slate-200 flex items-center justify-center">
            <i data-lucide="pie-chart" class="w-5 h-5 text-slate-700"></i>
          </div>
        </div>
      </div>

      <div class="p-5">
        <div class="h-[280px]">
          <canvas id="dealsDonut"></canvas>
        </div>

        <div class="mt-4 grid grid-cols-2 gap-2 text-sm">
          <div class="rounded-2xl bg-slate-50 border border-slate-200 p-3">
            <div class="text-slate-500 font-semibold">En proceso</div>
            <div class="text-xl font-extrabold text-slate-900">{{ deals_in_progress|default:0 }}</div>
          </div>
          <div class="rounded-2xl bg-slate-50 border border-slate-200 p-3">
            <div class="text-slate-500 font-semibold">Cerrados</div>
            <div class="text-xl font-extrabold text-slate-900">{{ deals_closed|default:0 }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Cotizaciones -->
    <div class="xl:col-span-3 rounded-3xl bg-white border border-slate-200 shadow-sm overflow-hidden">
      <div class="p-5 border-b border-slate-200">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-lg font-extrabold text-slate-900">Cotizaciones por mes</div>
            <div class="text-sm text-slate-600">Últimos 12 meses: en proceso vs cerradas + total</div>
          </div>
          <div class="w-10 h-10 rounded-2xl bg-slate-50 border border-slate-200 flex items-center justify-center">
            <i data-lucide="bar-chart-3" class="w-5 h-5 text-slate-700"></i>
          </div>
        </div>
      </div>

      <div class="p-5">
        <div class="h-[340px]">
          <canvas id="quotesChart"></canvas>
        </div>

        <div class="mt-3 text-xs text-slate-500">
          *Si no hay barras, revisa que existan fechas en las cotizaciones (created_at/fecha).
        </div>
      </div>
    </div>

  </div>

</div>

<!-- Data JSON seguro -->
{{ deals_chart|json_script:"deals-data" }}
{{ quotes_chart|json_script:"quotes-data" }}

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
  (function () {
    const deals = JSON.parse(document.getElementById("deals-data").textContent || "{}");
    const quotes = JSON.parse(document.getElementById("quotes-data").textContent || "{}");

    // ---------- Helpers ----------
    function sum(arr) {
      return (arr || []).reduce((a,b) => a + (Number(b) || 0), 0);
    }

    // ---------- Donut Negocios ----------
    const ctxDonut = document.getElementById("dealsDonut");
    if (ctxDonut && deals.labels && deals.values) {
      const total = sum(deals.values) || 1;

      new Chart(ctxDonut, {
        type: "doughnut",
        data: {
          labels: deals.labels,
          datasets: [{
            data: deals.values,
            borderWidth: 2,
            hoverOffset: 10,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: "72%",
          plugins: {
            legend: {
              position: "bottom",
              labels: { usePointStyle: true, boxWidth: 10 }
            },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const v = Number(ctx.raw || 0);
                  const pct = Math.round((v / total) * 100);
                  return ` ${ctx.label}: ${v} (${pct}%)`;
                }
              }
            }
          }
        }
      });
    }

    // ---------- Cotizaciones: barras apiladas + línea total ----------
    const ctxQ = document.getElementById("quotesChart");
    if (ctxQ && quotes.labels) {
      const labels = quotes.labels || [];
      const inProg = quotes.in_progress || [];
      const closed = quotes.closed || [];
      const total = quotes.total || inProg.map((v, i) => (Number(v)||0) + (Number(closed[i])||0));

      new Chart(ctxQ, {
        data: {
          labels: labels,
          datasets: [
            {
              type: "bar",
              label: "En proceso",
              data: inProg,
              borderWidth: 0,
              borderRadius: 12,
              borderSkipped: false,
              stack: "q",
            },
            {
              type: "bar",
              label: "Cerradas",
              data: closed,
              borderWidth: 0,
              borderRadius: 12,
              borderSkipped: false,
              stack: "q",
            },
            {
              type: "line",
              label: "Total",
              data: total,
              tension: 0.35,
              pointRadius: 3,
              pointHoverRadius: 5,
              borderWidth: 2,
              fill: false,
              yAxisID: "y",
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: "index", intersect: false },
          plugins: {
            legend: {
              position: "bottom",
              labels: { usePointStyle: true, boxWidth: 10 }
            },
            tooltip: { enabled: true }
          },
          scales: {
            x: {
              stacked: true,
              grid: { display: false },
              ticks: { maxRotation: 0, autoSkip: true }
            },
            y: {
              stacked: true,
              beginAtZero: true,
              grid: { color: "rgba(15,23,42,0.08)" } // slate-900 / 8%
            }
          }
        }
      });
    }
  })();
</script>
{% endblock %}